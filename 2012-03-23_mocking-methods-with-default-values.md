 PHPUnit test I've got stuck on a very <em>bizarre</em> bug. That's what my bugged code looked like:</p>&#13;
<pre>&lt;?php&#13;
class MyTest extends PHPUnit_Framework_TestCase&#13;
{&#13;
  public function mockingTest()&#13;
  {&#13;
    $valueMap = array(&#13;
      array('value1', 1),&#13;
      array('value2', 2),&#13;
    );&#13;
    $mock = $this-&gt;mock('MyClass');&#13;
&#13;
    $mock-&gt;expects($this-&gt;exactly(2))&#13;
      -&gt;method('get')&#13;
      -&gt;will($this-&gt;returnValueMap($valueMap));&#13;
&#13;
    $mock-&gt;get('value1');&#13;
    $mock-&gt;get('value2');&#13;
  }&#13;
}&#13;
</pre>&#13;
<p>The test was failing due to unmet mock expectations. After re-reading the documentation for few times I had to take a dive into PHPUnit's source to find out why.</p>&#13;
<p>The value map array needs to have the number of items equal to the number of method's arguments + 1 (the response you receive). <strong>That includes also the arguments with defaults</strong>.</p>&#13;
<p>So given that my MyClass definition is :</p>&#13;
<pre>&lt;?php&#13;
class MyClass&#13;
{&#13;
  $parameters = array();&#13;
&#13;
  public function get($key, $defaultValue = null)&#13;
  {&#13;
    return isset($this-&gt;parameters[$key]) ? $this-&gt;parameters[$key] : $defaultValue;&#13;
  }&#13;
&#13;
  //...&#13;
}&#13;
</pre>&#13;
<p>I should have rather defined my $valueMap like:</p>&#13;
<pre>    $valueMap = array(&#13;
      array('value1', null, 1),&#13;
      array('value2', null, 2),&#13;
    );&#13;
</pre>&#13;
<hr /><p>By the way, it's my first post on thumblr. Wish me luck ;)</p> 
